---
title: "HW06"
output: html_document
---
## 0. Packages and data
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
#library(lingtypology) # only for linguistic mapping
library(broom)
```


### UPSID database
In this dataset we have number of consonants and vowels in 402 languages collected from UPSID database (http://www.lapsyd.ddl.ish-lyon.cnrs.fr/lapsyd/).  
* `language` - language  
* `area` - language area according to Glottolog (http://glottolog.org/)  
* `consonants` - the number of consonants in the language  
* `vowels` - the number of vowels in the language  


```{r, warning=FALSE, message=FALSE}
upsid <- read_csv("https://raw.githubusercontent.com/LingData2019/LingData2020/master/data/upsid.csv")
upsid
```


```{r}
# you can map the languages using the lingtypology package
# map.feature(upsid$language, 
#            features = upsid$area,
#            label = upsid$language,
#            label.hide = TRUE)
```


In this work, you will fit a number of linear and linear mixed-effect models that predict the number of vowels in a language by the number of consonants and other variables.


## 1. Linear model


### 1.1 
Make a scatterplot of the number of consonants and the number of vowels using the `ggplot()`.   
```{r 1.1, echo = FALSE}
ggplot(upsid, aes(x = consonants, y = vowels)) +
  theme_bw() +
  geom_point() 

```


```{r}
# we use the theme_bw() theme, you can use other themes if you want
```
### 1.2
Fit the basic linear model `fit1` that predicts the number of vowels by the number of consonants. Look at the summary of the model.
```{r 1.2, include=FALSE}
fit1 <- lm(vowels ~ consonants, data = upsid)
summary(fit1)
```


### 1.3
Is `consonants` a significant predictor? Write down YES or NO.
```{1.3}
"YES"
```


### 1.4
*no evaluation*  
To draw predictions on the graph, we may use `fortify` function. It adds column entitled `.fitted` (note period) that is calculated as a prediction of a model as well as some other columns.


Try this code and see the result:


```{r}
head(fortify(fit1))
```
Another option is to use `augment` function from `broom` library that works in a similar way.


```{r}
library(broom)
head(augment(fit1))
```


### 1.5
Use one of these function to add a line to the scatterplot 1.1. You have to use `geom_line` and pass the result of `augment` or `fortify` as argument `data` in `geom_line`. (E.g. `geom_line(data = <result of augment>, ...`))


```{r 1.5, echo=FALSE}

ggplot(upsid, aes(x=consonants, y=vowels)) +
  theme_bw() +
  geom_point() +
  geom_line(data = augment(fit1), aes(x=consonants, y=.fitted), color = "blue")

```


## 2. Mixed-effect models
Let us look at the data with respect to the `area` groups. 


### 2.1
Re-build the scatterplot `1.1` coloring the points by `area`.
```{r 2.1, echo=FALSE}
ggplot(upsid, aes(consonants, vowels, color = area)) +
  theme_bw() +
  geom_point() +
  stat_ellipse()
```


### 2.2
Use lmer() to fit the model `fit2` with random `area` group intercept. Your model is given by equation:


$$vowels = \beta_0 + \beta_1 \times consonants + u(area).$$
```{r 2.2, include=FALSE}
fit2 <- lmer(vowels ~ consonants + (1|area), data = upsid)
summary(fit2)
```




### 2.3
Add the regression lines to the scatterplot `2.1` using `fortify` or `augment` methods.
```{r 2.3, echo=FALSE}

ggplot(upsid, aes(x = consonants, y = vowels, color = area)) + 
  geom_point() +
  theme_bw() +
  geom_line(data = augment(fit2), aes(x = consonants, y = .fitted, color = area))
```


### 2.4
Interpret the results of the model. (Use `summary()` to get information about your model.) Is _consonansts_ variable still significant? How it changes after we added _area_ random effect? What can you say about lines on the graph? How are they located with respect to each other? Why?


```{2.4}
Получается, что consonansts все еще значима. У нас увеличилось значение p-value, когда мы добавили area random effect. Что касается линий, то они параллельны, но находятся в пределах разных значений (т.е. одна над другой).

```




## 3. Mixed-effect models with random slopes.
### 3.1
Fit the model `fit3` with random slope that depends on _area_. Your model is given by formula:


$$vowels = \beta_0 + (\beta_1 + u(area))\times consonants.$$
You can consult [this](http://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-specification) manual to choose the correct syntax in your `lmer` formula.


```{r 3.1, include=FALSE}
fit3 <- lmer(vowels ~ consonants + (0 + consonants|area), data = upsid)
summary(fit3)

```


### 3.2
Draw a figure with prediction lines:


```{r 3.2, echo=FALSE}
ggplot(upsid, aes(x = consonants, y = vowels, color = area)) + 
  geom_point() +
  theme_bw() +
  geom_line(data = augment(fit3), aes(x = consonants, y = .fitted, color = area))
```


### 3.3
Interpret the results. Is _constants_ still significant? Why? What can you say about lines on the graph? How are they located with respect to each other? Why?


```{3.3}
Снова можно наблюдать увеличение значения p-value, только на сей раз consonants больше  не будет считаться значимым параметром.

Линии под наклоном, они больше не параллельны. Как мне кажется, на них повлиял random effect. При этом, кажется, линии выходят будто из одной точки.

```


## 4. Mixed-effect models with random intercept and random slopes.
Now let us assume we have both random intercept and random slope (and they are not correlated). Our model is of the form:


$$vowels = \beta_0 + u_1(area) + (\beta_1 + u_2(area))\times consonants.$$


### 4.1
Fit the model `fit4`.


```{r 4.1, include=FALSE}
fit4 <- lmer(vowels ~ consonants + (0 + consonants|area) + (1|area), data = upsid)
summary(fit4)
```


### 4.2
Draw a figure with predictions:  


```{r 4.2, echo=FALSE}
ggplot(upsid, aes(x = consonants, y = vowels, color = area)) + 
  geom_point() +
  theme_bw() +
  geom_line(data = augment(fit4), aes(x = consonants, y=.fitted, color = area))
```


### 4.3
Interpret the results. Is _constants_ significant? How can we interpret the difference between the prediction lines of these three models?

Consonants is not significant in this model. The difference between prediction lines in the models can be explained by the fact that random effect is applied to intercept, slope, and both at the same time. The result of the first model may mean that there is a certain minimal amount of vowels in languages that depends on the area. In the second model we can say that the amount of consonant affects the amount of vowels in a different way (i.e. to a different degree) depending on the area. And the third model combines these two approaches which, in theory, should provide the best fit.


```{4.3}

Для этой модели consonants не является значимой переменной.

Они больше не выходят "из одной точки", то есть произошло смещение, а также поменялся наклон линий.

Видимо, первая модель показывает, что area влияет на минимальное число гласных. Вторая модель показывает, что число согласных по-разному влияет на число гласных. А третья модель объединяет все подходы и учитывает и то, и то.
